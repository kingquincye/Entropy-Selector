<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entropy Selector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        :root {
            --primary: #8b5cf6;
            /* Violet 500 */
            --primary-dark: #6d28d9;
            /* Violet 700 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            /* Slate 900 */
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Glitch effect class for the result */
        .glitch-anim {
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
        }

        @keyframes glitch {
            0% {
                transform: translate(0)
            }

            20% {
                transform: translate(-2px, 2px)
            }

            40% {
                transform: translate(-2px, -2px)
            }

            60% {
                transform: translate(2px, 2px)
            }

            80% {
                transform: translate(2px, -2px)
            }

            100% {
                transform: translate(0)
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4 selection:bg-purple-500 selection:text-white">

    <!-- Header -->
    <header class="w-full max-w-3xl flex justify-between items-center mb-6 mt-2">
        <div class="flex items-center gap-2">
            <i data-lucide="shuffle" class="text-purple-400 w-8 h-8"></i>
            <h1 class="text-2xl font-bold tracking-tight text-white">Entropy <span
                    class="text-purple-500">Selector</span></h1>
        </div>
        <div class="text-xs font-mono text-gray-500 border border-gray-700 px-2 py-1 rounded">
            v2.0 :: CRYPTO_SECURE
        </div>
    </header>

    <!-- Main Card -->
    <main
        class="w-full max-w-3xl bg-slate-800/50 backdrop-blur-lg rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col md:flex-row">

        <!-- Left Panel: Controls & Input -->
        <section class="w-full md:w-1/2 p-6 border-b md:border-b-0 md:border-r border-slate-700 flex flex-col gap-4">

            <!-- Mode Toggle -->
            <div class="bg-slate-900/50 p-1 rounded-lg flex text-sm font-medium">
                <button id="mode-deck"
                    class="flex-1 py-2 px-3 rounded-md bg-purple-600 text-white shadow transition-all flex items-center justify-center gap-2"
                    onclick="setMode('deck')">
                    <i data-lucide="layers" class="w-4 h-4"></i> Deck (Exhaustive)
                </button>
                <button id="mode-infinite"
                    class="flex-1 py-2 px-3 rounded-md text-slate-400 hover:text-white transition-all flex items-center justify-center gap-2"
                    onclick="setMode('infinite')">
                    <i data-lucide="infinity" class="w-4 h-4"></i> Infinite
                </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-900 rounded p-2 border border-slate-700">
                    <div class="text-xs text-slate-400 uppercase tracking-wider">Total Items</div>
                    <div id="count-total" class="text-xl font-mono font-bold text-white">0</div>
                </div>
                <div class="bg-slate-900 rounded p-2 border border-slate-700 relative overflow-hidden">
                    <div class="absolute inset-0 bg-purple-500/10 hidden" id="progress-bar"></div>
                    <div class="relative z-10">
                        <div class="text-xs text-slate-400 uppercase tracking-wider">Remaining</div>
                        <div id="count-remaining" class="text-xl font-mono font-bold text-purple-400">0</div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="flex-1 flex flex-col relative">
                <div class="flex justify-between items-end mb-1">
                    <label class="text-xs text-slate-400 font-bold uppercase">Data Pool</label>
                    <button onclick="clearInput()"
                        class="text-xs text-red-400 hover:text-red-300 transition-colors">Clear</button>
                </div>
                <textarea id="input-area"
                    class="w-full flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm font-mono focus:outline-none focus:border-purple-500 transition-colors resize-none text-slate-300 placeholder-slate-600"
                    placeholder="Enter items here...&#10;One per line&#10;Paste from Excel/Text&#10;Supports 10k+ lines"></textarea>
                <div
                    class="absolute bottom-3 right-3 text-[10px] text-slate-600 pointer-events-none bg-slate-900 px-1 rounded">
                    INPUT
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="processInput()"
                    class="col-span-2 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-medium transition-colors border border-slate-600">
                    Load / Reset Deck
                </button>
            </div>
        </section>

        <!-- Right Panel: Display & History -->
        <section class="w-full md:w-1/2 bg-slate-900 flex flex-col">

            <!-- Result Display -->
            <div
                class="flex-1 flex flex-col items-center justify-center p-8 min-h-[250px] relative overflow-hidden group">
                <!-- Background decoration -->
                <div
                    class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/20 via-slate-900 to-slate-900">
                </div>

                <div id="empty-state" class="text-center opacity-50 relative z-10">
                    <i data-lucide="box" class="w-12 h-12 mx-auto mb-2 text-slate-600"></i>
                    <p class="text-slate-500 text-sm">Ready for data</p>
                </div>

                <div id="result-container" class="hidden relative z-10 w-full text-center">
                    <div class="text-xs font-mono text-purple-500 mb-2 tracking-[0.2em] uppercase">Selected</div>
                    <h2 id="result-text" class="text-3xl md:text-4xl font-bold text-white leading-tight break-words">
                        <!-- Result goes here -->
                    </h2>
                </div>

                <!-- Big Pick Button (Floating on Mobile, Fixed here on Desktop) -->
                <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-900 to-transparent">
                    <button onclick="pick()" id="pick-btn"
                        class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-purple-900/50 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 group-hover:shadow-purple-700/50">
                        <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                        EXECUTE SELECTION
                    </button>
                </div>
            </div>

            <!-- History Log -->
            <div class="h-48 md:h-64 bg-slate-950 border-t border-slate-800 flex flex-col">
                <div class="p-3 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="history" class="w-3 h-3"></i> Log
                    </span>
                    <button onclick="clearHistory()"
                        class="text-xs text-slate-500 hover:text-white transition-colors">Clear Log</button>
                </div>
                <ul id="history-list" class="flex-1 overflow-y-auto p-2 space-y-1 font-mono text-sm">
                    <!-- History items -->
                    <li class="text-slate-600 text-xs text-center py-4 italic">No history yet...</li>
                </ul>
            </div>

        </section>
    </main>

    <!-- Footer -->
    <footer class="mt-8 text-center text-slate-600 text-xs">
        <p>Running in strictly local environment.</p>
        <p class="mt-1 font-mono">Crypto.getRandomValues() active</p>
    </footer>

    <script>
        // --- STATE ---
        let items = [];         // The master list of items
        let deck = [];          // The working list for "Deck" mode
        let currentMode = 'deck'; // 'deck' or 'infinite'
        let history = [];

        // --- DOM ELEMENTS ---
        const inputArea = document.getElementById('input-area');
        const resultText = document.getElementById('result-text');
        const resultContainer = document.getElementById('result-container');
        const emptyState = document.getElementById('empty-state');
        const countTotal = document.getElementById('count-total');
        const countRemaining = document.getElementById('count-remaining');
        const historyList = document.getElementById('history-list');
        const pickBtn = document.getElementById('pick-btn');
        const btnModeDeck = document.getElementById('mode-deck');
        const btnModeInfinite = document.getElementById('mode-infinite');

        // --- INIT ---
        lucide.createIcons();
        loadFromStorage();

        // --- CORE LOGIC ---

        // Cryptographically Secure Random Number Generator (0 inclusive to 1 exclusive)
        // Replaces Math.random() for security
        function secureRandom() {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] / (0xFFFFFFFF + 1);
        }

        function setMode(mode) {
            currentMode = mode;

            // Visual Toggle
            if (mode === 'deck') {
                btnModeDeck.classList.remove('bg-transparent', 'text-slate-400');
                btnModeDeck.classList.add('bg-purple-600', 'text-white');
                btnModeInfinite.classList.remove('bg-purple-600', 'text-white');
                btnModeInfinite.classList.add('bg-transparent', 'text-slate-400');
                processInput(); // Re-initialize deck
            } else {
                btnModeInfinite.classList.remove('bg-transparent', 'text-slate-400');
                btnModeInfinite.classList.add('bg-purple-600', 'text-white');
                btnModeDeck.classList.remove('bg-purple-600', 'text-white');
                btnModeDeck.classList.add('bg-transparent', 'text-slate-400');
                updateStats();
            }
        }

        // Parse Input and Update Lists
        function processInput() {
            const raw = inputArea.value;
            // Split by newline, filter empty lines, trim whitespace
            items = raw.split(/\n/).map(line => line.trim()).filter(line => line.length > 0);

            // Save to local storage for QoL
            localStorage.setItem('selector_input', raw);

            if (currentMode === 'deck') {
                resetDeck();
            }
            updateStats();
        }

        function resetDeck() {
            // Create a copy and shuffle it using Fisher-Yates with Crypto
            deck = [...items];
            fisherYatesShuffle(deck);
            updateStats();

            // UI Feedback
            if (items.length > 0) {
                pickBtn.textContent = "EXECUTE SELECTION";
                pickBtn.disabled = false;
                pickBtn.classList.remove('bg-slate-700');
                pickBtn.classList.add('bg-purple-600');
            }
        }

        // The "True Random" Shuffle
        function fisherYatesShuffle(array) {
            let m = array.length, t, i;
            // While there remain elements to shuffle…
            while (m) {
                // Pick a remaining element using Crypto RNG
                i = Math.floor(secureRandom() * m--);
                // And swap it with the current element.
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
            return array;
        }

        function pick() {
            if (items.length === 0) {
                alert("Please enter some items in the Data Pool first.");
                return;
            }

            let selectedItem = "";

            if (currentMode === 'deck') {
                if (deck.length === 0) {
                    // Auto-reshuffle or Ask? For flow, let's auto-reshuffle notification
                    pickBtn.textContent = "DECK EMPTY - RELOAD";
                    pickBtn.classList.remove('bg-purple-600');
                    pickBtn.classList.add('bg-slate-700');
                    return; // Prevent picking
                }
                // Pop from the shuffled deck (efficient O(1))
                selectedItem = deck.pop();
            } else {
                // Infinite Mode: Pick random index
                const idx = Math.floor(secureRandom() * items.length);
                selectedItem = items[idx];
            }

            // Display Result
            displayResult(selectedItem);
            addToHistory(selectedItem);
            updateStats();
        }

        function displayResult(text) {
            emptyState.classList.add('hidden');
            resultContainer.classList.remove('hidden');

            // Animation reset
            resultText.classList.remove('glitch-anim');
            void resultText.offsetWidth; // Trigger reflow
            resultText.textContent = text;
            resultText.classList.add('glitch-anim');

            // Stop glitch after a moment
            setTimeout(() => {
                resultText.classList.remove('glitch-anim');
            }, 300);
        }

        function updateStats() {
            countTotal.textContent = items.length;

            if (currentMode === 'deck') {
                countRemaining.textContent = deck.length;
                countRemaining.parentElement.parentElement.classList.remove('opacity-50');

                if (items.length > 0 && deck.length === 0) {
                    pickBtn.textContent = "RESET DECK";
                    pickBtn.classList.remove('bg-purple-600');
                    pickBtn.classList.add('bg-slate-700');
                } else if (items.length > 0) {
                    pickBtn.textContent = "EXECUTE SELECTION";
                    pickBtn.classList.add('bg-purple-600');
                    pickBtn.classList.remove('bg-slate-700');
                }

            } else {
                countRemaining.textContent = "∞";
                countRemaining.parentElement.parentElement.classList.add('opacity-50');
                pickBtn.textContent = "EXECUTE RANDOM";
            }
        }

        function addToHistory(item) {
            // Remove "No history" msg if exists
            if (historyList.firstElementChild && historyList.firstElementChild.innerText === "No history yet...") {
                historyList.innerHTML = '';
            }

            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false, hour: "numeric", minute: "numeric", second: "numeric" });

            const li = document.createElement('li');
            li.className = "flex items-center gap-3 p-2 bg-slate-900/50 rounded border border-slate-800/50 animate-[fadeIn_0.3s_ease-out]";
            li.innerHTML = `
                <span class="text-slate-500 text-[10px]">${timestamp}</span>
                <span class="text-purple-300 flex-1 truncate">${item}</span>
            `;

            historyList.prepend(li);

            // Keep history memory sane (limit to last 100 for DOM performance)
            if (historyList.children.length > 100) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        function clearInput() {
            inputArea.value = '';
            processInput();
            inputArea.focus();
        }

        function clearHistory() {
            historyList.innerHTML = '<li class="text-slate-600 text-xs text-center py-4 italic">No history yet...</li>';
        }

        // Persistence
        function loadFromStorage() {
            const savedData = localStorage.getItem('selector_input');
            if (savedData) {
                inputArea.value = savedData;
                processInput();
            }
        }

        // Add tailwind animation for history
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-5px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>

</html>